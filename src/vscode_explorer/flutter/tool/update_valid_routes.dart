import 'dart:io';

void main() {
  final routeConfigFile = File('lib/route/route_configuration.dart');
  final validRoutesFile = File('lib/route/valid_routes.dart');

  if (!routeConfigFile.existsSync()) {
    print('âŒ Error: route_configuration.dart not found.');
    exit(1);
  }

  final content = routeConfigFile.readAsStringSync();

  // âœ… æ”¹è‰¯çš„ Regexï¼Œæ”¯æ´è·¨è¡Œ
  final regex = RegExp(
    r'const\s+String\s+(ROUTE_[A-Z0-9_]+)\s*=\s*[\s\S]*?routeName\s*;',
    multiLine: true,
  );

  final matches = regex.allMatches(content);
  final newRoutes = matches.map((m) => m.group(1)!).toSet()
    ..removeWhere((e) => e.trim().isEmpty);

  // âœ… è®€å–èˆŠçš„ validRoutes
  final previousRoutes = <String>{};
  if (validRoutesFile.existsSync()) {
    final oldContent = validRoutesFile.readAsStringSync();
    final oldRegex = RegExp(r'ROUTE_[A-Z0-9_]+');
    previousRoutes
        .addAll(oldRegex.allMatches(oldContent).map((m) => m.group(0)!));
  }

  // âœ… æ¯”å°å·®ç•°
  final added = newRoutes.difference(previousRoutes).toList()..sort();
  final removed = previousRoutes.difference(newRoutes).toList()..sort();

  // âœ… è¼¸å‡ºè®Šæ›´æ‘˜è¦
  if (added.isEmpty && removed.isEmpty) {
    print('âœ… No route changes detected.');
  } else {
    print('ğŸ“ Route changes detected:');
    if (added.isNotEmpty) print('â• Added: ${added.join(', ')}');
    if (removed.isNotEmpty) print('â– Removed: ${removed.join(', ')}');
  }

  // âœ… ç”¢ç”Ÿæ–°æª”æ¡ˆå…§å®¹
  final buffer = StringBuffer();
  buffer
      .writeln('// This file is auto-generated by generate_valid_routes.dart.');
  buffer.writeln('// Do not modify this file manually.\n');
  buffer.writeln(
      '// Manual run "dart run tool/generate_valid_routes.dart" .\n\n');
  buffer.writeln(
      'import \'package:owlpay_cash/route/route_configuration.dart\';\n');
  buffer.writeln('final List<String> validRoutes = [');
  for (final route in newRoutes.toList()
    ..toList()
    ..sort()) {
    buffer.writeln('  $route,');
  }
  buffer.writeln('];');

  // âœ… å¯«å…¥æª”æ¡ˆ
  validRoutesFile.writeAsStringSync(buffer.toString());
  print('âœ… valid_routes.dart regenerated with ${newRoutes.length} routes.');
  // path
  print('ğŸ“‚ File written to: ${validRoutesFile.path}');
  // âœ… Optionalï¼šå¦‚æœæœ‰è®Šæ›´ä½† CI è¦æª¢æŸ¥ commit æ²’è·Ÿä¸Šï¼Œå°±åŠ ä¸Šé€€å‡ºç¢¼
  if ((added.isNotEmpty || removed.isNotEmpty) &&
      Platform.environment['CI'] == 'true') {
    print(
        'â— Detected unsynced route changes. Please commit updated valid_routes.dart.');
    exit(2); // è®“ CI å ±éŒ¯
  }
}
